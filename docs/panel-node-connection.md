# ارتباط نود با پنل پاسارگارد

این سند فیلدهای صفحه **Modify Node** در پنل را به تنظیمات همین سرور (نود) و فایل `.env` نگاشت می‌کند.

## نگاشت فیلدهای پنل ↔ سرور

| فیلد در پنل (Modify Node) | مقدار در پنل | تنظیم روی سرور / `.env` |
|---------------------------|-------------|--------------------------|
| **Node Name** | نام نود (مثلاً adak) | فقط برای نمایش در پنل؛ اختیاری |
| **Node Address** | آی‌پی یا دامنه عمومی **همین سرور** (مثلاً `5.196.129.144`) | همان IP/دامنه‌ای که کاربران و پنل به آن وصل می‌شوند. پورت `SERVICE_PORT` روی این آدرس باید از اینترنت باز باشد. |
| **Node Port** | پورت نود (مثلاً `62050`) | در `.env`: `SERVICE_PORT=62050` (پورت ارتباط پنل با نود؛ پورت VLESS مثل 1080 جداگانه در Core Configuration تعریف می‌شود) |
| **Advanced Settings → API Port** | پورت API برای آپدیت Xray (مثلاً `62051`) | در `.env`: `API_PORT=62051` |
| **Core Configuration** | `CORE-TS` (برای نود Tailscale) | پیکربندی ما با Tailscale هماهنگ است. |
| **API Key** | کلید یکتا از پنل (مثلاً `72ea0b16-1d1d-46e2-bdea-0c9c97dbd29d`) | در `.env`: `API_KEY=<همان مقدار>` |
| **Certificate** | گواهی SSL نود | همان گواهی که روی نود در مسیر `SSL_CERT_FILE` قرار دارد؛ محتوای فایل `ssl_cert.pem` را کپی و در این فیلد در پنل paste کن. |

## جریان ارتباط

1. **پنل → نود:** پنل با استفاده از **Node Address** و **Node Port** و **Certificate** به نود وصل می‌شود (gRPC روی TLS).
2. **نود → پنل:** نود با **API_KEY** و آدرس **PANEL_HOST** به پنل متصل می‌شود و کانفیگ و لیست کلاینت‌ها را می‌گیرد.

## گواهی SSL روی نود

- مسیر روی نود (داخل کانتینر):  
  `SSL_CERT_FILE=/var/lib/pg-node/certs/ssl_cert.pem`  
  `SSL_KEY_FILE=/var/lib/pg-node/certs/ssl_key.pem`
- **ساخت گواهی:** قبل از اولین اجرای نود، اسکریپت زیر را اجرا کن:

  ```bash
  ./scripts/gen-certs.sh
  ```

  گواهی‌ها در `data/pg-node/certs/` ساخته می‌شوند (ssl_cert.pem و ssl_key.pem). برای دامنه یا IP مشخص:

  ```bash
  SSL_CN=5.196.129.144 ./scripts/gen-certs.sh
  ```

- محتوای **عمومی** گواهی (`ssl_cert.pem`، از `-----BEGIN CERTIFICATE-----` تا `-----END CERTIFICATE-----`) را در فیلد **Certificate** در صفحه Modify Node در پنل قرار بده.

## VLESS روی پورت 1080 (یا پورت دلخواه)

برای اتصال کاربران با لینک VLESS به آدرس `Node Address:1080` (مثلاً `5.196.129.144:1080`):

1. **Core Configuration در پنل:** در Modify Node، در بخش **Core Configuration** یک پیکربندی انتخاب یا تعریف کن که شامل inbound روی پورت **1080** باشد (مثلاً VLESS با HTTP header و `host=skyroom.online` و `path=/`). پنل این کانفیگ را برای نود می‌فرستد و Xray روی نود همان را اجرا می‌کند.
2. **باز بودن پورت روی سرور:** در این پروژه پورت 1080 از طریق `docker-compose` اکسپوز شده است (`VLESS_PORT=1080` در `.env`). روی سرور و فایروال هم پورت 1080 را برای TCP باز کن:
   ```bash
   sudo ufw allow 1080/tcp
   sudo ufw reload
   ```
3. **لینک کلاینت:** بعد از ذخیره و اعمال تنظیمات در پنل، لینک VLESS با آدرس و پورت صحیح (مثلاً `5.196.129.144:1080`) و پارامترهای هم‌خوان با همان inbound (encryption=none, type=http, host=skyroom.online, path=/, method=GET) را به کاربران بده.

**توجه:** مقدار **Node Port** در پنل (مثلاً 62050) فقط برای ارتباط پنل↔نود است. پورت VLESS (مثلاً 1080) داخل همان Core Configuration تعریف می‌شود و باید در compose و فایروال باز باشد.

## اگر پنل «Error» یا «Checking…» نشان می‌دهد

- مطمئن شو نود با `docker compose up -d` بالا است و پورت `SERVICE_PORT` روی **Node Address** از اینترنت (و در صورت نیاز از شبکه پنل) در دسترس است.
- فایروال سرور را چک کن: پورت `SERVICE_PORT` (مثلاً 62050) برای TCP باز باشد.
- مطمئن شو **API Key** در `.env` دقیقاً همان کلیدی است که در پنل برای این نود ثبت شده.
- مطمئن شو **Certificate** در پنل عیناً همان محتوای `ssl_cert.pem` نود است (بدون تغییر و بدون فاصله/خط اضافه).
